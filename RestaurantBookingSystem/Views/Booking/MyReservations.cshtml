@model RestaurantBookingSystem.ViewModels.MyReservationsViewModel
@{
    ViewData["Title"] = "My Reservations";
}

<div class="my-reservations-page">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1>My Reservations</h1>
                <p class="subtitle">Manage your upcoming and past restaurant bookings</p>
            </div>
            <a asp-controller="Restaurant" asp-action="Search" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Reservation
            </a>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="tab-btn active" data-filter="upcoming" onclick="filterReservations('upcoming')">
                <i class="fas fa-calendar-day"></i>
                <span>Upcoming</span>
                <span class="badge">@Model.UpcomingReservations.Count()</span>
            </button>
            <button class="tab-btn" data-filter="past" onclick="filterReservations('past')">
                <i class="fas fa-history"></i>
                <span>Past</span>
                <span class="badge">@Model.PastReservations.Count()</span>
            </button>
            <button class="tab-btn" data-filter="cancelled" onclick="filterReservations('cancelled')">
                <i class="fas fa-ban"></i>
                <span>Cancelled</span>
                <span class="badge">@Model.CancelledReservations.Count()</span>
            </button>
        </div>

        <!-- Upcoming Reservations -->
        <div class="reservations-section" id="upcoming-section">
            <h2 class="section-title">
                <i class="fas fa-calendar-check"></i>
                Upcoming Reservations
            </h2>

            @if (Model.UpcomingReservations.Any())
            {
                <div class="reservations-grid">
                    @foreach (var reservation in Model.UpcomingReservations)
                    {
                        <div class="reservation-card" data-reservation-id="@reservation.BookingReference">
                            <div class="card-header-img" style="background-image: url('@(reservation.RestaurantPhoto ?? "/images/default-restaurant.jpg")')">
                                <div class="status-badge status-@reservation.Status.ToString().ToLower()">
                                    @reservation.Status
                                </div>
                            </div>
                            
                            <div class="card-body">
                                <h3 class="restaurant-name">@reservation.RestaurantName</h3>
                                <div class="reservation-ref">@reservation.BookingReference</div>
                                
                                <div class="reservation-details">
                                    <div class="detail-row">
                                        <i class="fas fa-calendar"></i>
                                        <span>@reservation.ReservationDate.ToString("dddd, MMMM dd, yyyy")</span>
                                    </div>
                                    <div class="detail-row">
                                        <i class="fas fa-clock"></i>
                                        <span>@reservation.ReservationTime.ToString("h:mm tt")</span>
                                    </div>
                                    <div class="detail-row">
                                        <i class="fas fa-users"></i>
                                        <span>@reservation.NumberOfGuests @(reservation.NumberOfGuests == 1 ? "Guest" : "Guests")</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(reservation.TableLocation))
                                    {
                                        <div class="detail-row">
                                            <i class="fas fa-chair"></i>
                                            <span>Table @reservation.TableNumber (@reservation.TableLocation)</span>
                                        </div>
                                    }
                                </div>

                                @if (!string.IsNullOrEmpty(reservation.SpecialRequests))
                                {
                                    <div class="special-note">
                                        <i class="fas fa-comment"></i>
                                        <span>@reservation.SpecialRequests</span>
                                    </div>
                                }

                                <!-- Countdown Timer -->
                                @{
                                    var timeUntil = reservation.ReservationDate.Add(reservation.ReservationTime) - DateTime.Now;
                                    if (timeUntil.TotalHours > 0 && timeUntil.TotalDays < 7)
                                    {
                                        <div class="countdown-timer">
                                            <i class="fas fa-hourglass-half"></i>
                                            @if (timeUntil.TotalDays >= 1)
                                            {
                                                <span>In @((int)timeUntil.TotalDays) day@(timeUntil.TotalDays >= 2 ? "s" : "")</span>
                                            }
                                            else if (timeUntil.TotalHours >= 1)
                                            {
                                                <span>In @((int)timeUntil.TotalHours) hour@(timeUntil.TotalHours >= 2 ? "s" : "")</span>
                                            }
                                            else
                                            {
                                                <span>Coming up soon!</span>
                                            }
                                        </div>
                                    }
                                }
                            </div>

                            <div class="card-actions">
                                <a asp-controller="Booking" asp-action="Details" asp-route-id="@reservation.BookingReference" 
                                   class="btn btn-outline btn-sm">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                                @if (reservation.Status != RestaurantBookingSystem.Models.ReservationStatus.Cancelled && 
                                     reservation.CanCancel)
                                {
                                    <button class="btn btn-danger btn-sm" onclick="cancelReservation('@reservation.BookingReference')">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <h3>No Upcoming Reservations</h3>
                    <p>You don't have any upcoming reservations. Ready to book a table?</p>
                    <a asp-controller="Restaurant" asp-action="Search" class="btn btn-primary">
                        <i class="fas fa-search"></i> Find Restaurants
                    </a>
                </div>
            }
        </div>

        <!-- Past Reservations -->
        <div class="reservations-section" id="past-section" style="display: none;">
            <h2 class="section-title">
                <i class="fas fa-history"></i>
                Past Reservations
            </h2>

            @if (Model.PastReservations.Any())
            {
                <div class="reservations-list">
                    @foreach (var reservation in Model.PastReservations)
                    {
                        <div class="reservation-list-item">
                            <div class="item-image" style="background-image: url('@(reservation.RestaurantPhoto ?? "/images/default-restaurant.jpg")')"></div>
                            
                            <div class="item-content">
                                <div class="item-header">
                                    <h4>@reservation.RestaurantName</h4>
                                    <span class="reservation-ref-sm">@reservation.BookingReference</span>
                                </div>
                                <div class="item-details">
                                    <span><i class="fas fa-calendar"></i> @reservation.ReservationDate.ToString("MMM dd, yyyy")</span>
                                    <span><i class="fas fa-clock"></i> @reservation.ReservationTime.ToString("h:mm tt")</span>
                                    <span><i class="fas fa-users"></i> @reservation.NumberOfGuests guests</span>
                                </div>
                                @if (reservation.Status == RestaurantBookingSystem.Models.ReservationStatus.Completed && 
                                     !reservation.HasReview)
                                {
                                    <div class="review-prompt">
                                        <i class="fas fa-star"></i>
                                        <span>How was your experience?</span>
                                        <a href="#" class="btn-link">Write a Review</a>
                                    </div>
                                }
                            </div>

                            <div class="item-actions">
                                <a asp-controller="Booking" asp-action="Details" asp-route-id="@reservation.BookingReference" 
                                   class="btn btn-outline btn-sm">
                                    View Details
                                </a>
                                <button class="btn btn-primary btn-sm">
                                    <i class="fas fa-redo"></i> Book Again
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <h3>No Past Reservations</h3>
                    <p>You haven't completed any reservations yet.</p>
                </div>
            }
        </div>

        <!-- Cancelled Reservations -->
        <div class="reservations-section" id="cancelled-section" style="display: none;">
            <h2 class="section-title">
                <i class="fas fa-ban"></i>
                Cancelled Reservations
            </h2>

            @if (Model.CancelledReservations.Any())
            {
                <div class="reservations-list">
                    @foreach (var reservation in Model.CancelledReservations)
                    {
                        <div class="reservation-list-item cancelled">
                            <div class="item-image" style="background-image: url('@(reservation.RestaurantPhoto ?? "/images/default-restaurant.jpg")')"></div>
                            
                            <div class="item-content">
                                <div class="item-header">
                                    <h4>@reservation.RestaurantName</h4>
                                    <span class="status-badge status-cancelled">Cancelled</span>
                                </div>
                                <div class="item-details">
                                    <span><i class="fas fa-calendar"></i> @reservation.ReservationDate.ToString("MMM dd, yyyy")</span>
                                    <span><i class="fas fa-clock"></i> @reservation.ReservationTime.ToString("h:mm tt")</span>
                                    <span><i class="fas fa-users"></i> @reservation.NumberOfGuests guests</span>
                                </div>
                                @if (reservation.CancellationDate.HasValue)
                                {
                                    <div class="cancellation-info">
                                        Cancelled on @reservation.CancellationDate.Value.ToString("MMM dd, yyyy")
                                    </div>
                                }
                            </div>

                            <div class="item-actions">
                                <button class="btn btn-primary btn-sm">
                                    <i class="fas fa-redo"></i> Book Again
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <h3>No Cancelled Reservations</h3>
                    <p>You haven't cancelled any reservations.</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancelModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Cancel Reservation</h3>
            <button class="modal-close" onclick="closeCancelModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="warning-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <p>Are you sure you want to cancel this reservation?</p>
            <p class="modal-ref">Booking Reference: <strong id="cancelRef"></strong></p>
            <div class="form-group">
                <label>Reason for cancellation (optional)</label>
                <textarea id="cancellationReason" class="form-control" rows="3" 
                          placeholder="Let us know why you're cancelling..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeCancelModal()">Keep Reservation</button>
            <button class="btn btn-danger" onclick="confirmCancel()">Yes, Cancel</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentCancelRef = null;

        function filterReservations(filter) {
            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

            // Show/hide sections
            document.querySelectorAll('.reservations-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`${filter}-section`).style.display = 'block';
        }

        function cancelReservation(bookingRef) {
            currentCancelRef = bookingRef;
            document.getElementById('cancelRef').textContent = bookingRef;
            document.getElementById('cancelModal').style.display = 'flex';
        }

        function closeCancelModal() {
            document.getElementById('cancelModal').style.display = 'none';
            document.getElementById('cancellationReason').value = '';
            currentCancelRef = null;
        }

        function confirmCancel() {
            if (!currentCancelRef) return;

            const reason = document.getElementById('cancellationReason').value;
            
            // Show loading state
            const modal = document.getElementById('cancelModal');
            modal.querySelector('.modal-body').innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary-color);"></i>
                    <p style="margin-top: 1rem;">Cancelling reservation...</p>
                </div>
            `;

            // Simulate API call (replace with actual endpoint)
            fetch(`/Booking/Cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bookingReference: currentCancelRef,
                    reason: reason
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    modal.querySelector('.modal-body').innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success-color);"></i>
                            <h3 style="margin-top: 1rem;">Reservation Cancelled</h3>
                            <p>Your reservation has been successfully cancelled.</p>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        closeCancelModal();
                        location.reload();
                    }, 2000);
                } else {
                    alert('Failed to cancel reservation. Please try again.');
                    closeCancelModal();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                closeCancelModal();
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('cancelModal');
            if (event.target == modal) {
                closeCancelModal();
            }
        }
    </script>
}

<style>
.my-reservations-page {
    min-height: calc(100vh - 200px);
    padding: 3rem 0;
    background: #f5f7fa;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 2rem;
}

.page-header h1 {
    font-size: 2.5rem;
    color: var(--text-color);
    margin-bottom: 0.5rem;
}

.subtitle {
    color: var(--text-light);
    font-size: 1.125rem;
}

/* Filter Tabs */
.filter-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    background: white;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.tab-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 1rem;
    background: transparent;
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    color: var(--text-light);
}

.tab-btn:hover {
    background: #f8f9fa;
}

.tab-btn.active {
    background: rgba(218, 55, 67, 0.1);
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.tab-btn .badge {
    background: #e9ecef;
    color: var(--text-color);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
}

.tab-btn.active .badge {
    background: var(--primary-color);
    color: white;
}

/* Section Title */
.section-title {
    font-size: 1.5rem;
    color: var(--text-color);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-title i {
    color: var(--primary-color);
}

/* Reservations Grid */
.reservations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
}

.reservation-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: var(--transition);
}

.reservation-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.card-header-img {
    height: 200px;
    background-size: cover;
    background-position: center;
    position: relative;
}

.status-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    backdrop-filter: blur(10px);
}

.status-badge.status-confirmed {
    background: rgba(13, 202, 240, 0.9);
    color: white;
}

.status-badge.status-pending {
    background: rgba(255, 193, 7, 0.9);
    color: #333;
}

.status-badge.status-cancelled {
    background: rgba(220, 53, 69, 0.9);
    color: white;
}

.card-body {
    padding: 1.5rem;
}

.restaurant-name {
    font-size: 1.5rem;
    color: var(--text-color);
    margin-bottom: 0.5rem;
}

.reservation-ref {
    font-family: monospace;
    color: var(--text-light);
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.reservation-details {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.detail-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text-color);
}

.detail-row i {
    width: 20px;
    color: var(--primary-color);
}

.special-note {
    display: flex;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #fff3cd;
    border-radius: 6px;
    margin-top: 1rem;
    font-size: 0.9rem;
    color: #856404;
}

.special-note i {
    flex-shrink: 0;
}

.countdown-timer {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: #e7f3ff;
    border-radius: 6px;
    margin-top: 1rem;
    color: #0c5460;
    font-weight: 600;
}

.card-actions {
    display: flex;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid #e9ecef;
}

.card-actions .btn {
    flex: 1;
}

/* List View */
.reservations-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.reservation-list-item {
    display: grid;
    grid-template-columns: 120px 1fr auto;
    gap: 1.5rem;
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: var(--transition);
}

.reservation-list-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.reservation-list-item.cancelled {
    opacity: 0.7;
}

.item-image {
    width: 120px;
    height: 120px;
    border-radius: 8px;
    background-size: cover;
    background-position: center;
}

.item-content {
    flex: 1;
}

.item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.item-header h4 {
    font-size: 1.25rem;
    color: var(--text-color);
    margin: 0;
}

.reservation-ref-sm {
    font-family: monospace;
    font-size: 0.875rem;
    color: var(--text-light);
}

.item-details {
    display: flex;
    gap: 1.5rem;
    color: var(--text-light);
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
}

.item-details span {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.item-details i {
    color: var(--primary-color);
}

.review-prompt {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #fff3cd;
    border-radius: 6px;
    margin-top: 0.5rem;
}

.review-prompt i {
    color: #ffc107;
}

.btn-link {
    color: var(--primary-color);
    font-weight: 600;
    text-decoration: none;
    margin-left: auto;
}

.btn-link:hover {
    text-decoration: underline;
}

.cancellation-info {
    font-size: 0.875rem;
    color: var(--text-light);
    font-style: italic;
}

.item-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    justify-content: center;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 12px;
}

.empty-state i {
    font-size: 4rem;
    color: var(--text-light);
    opacity: 0.5;
    margin-bottom: 1.5rem;
}

.empty-state h3 {
    font-size: 1.5rem;
    color: var(--text-color);
    margin-bottom: 1rem;
}

.empty-state p {
    color: var(--text-light);
    margin-bottom: 2rem;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.modal-header h3 {
    margin: 0;
    color: var(--text-color);
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: var(--text-light);
    line-height: 1;
}

.modal-close:hover {
    color: var(--text-color);
}

.modal-body {
    padding: 2rem;
}

.warning-icon {
    text-align: center;
    margin-bottom: 1.5rem;
}

.warning-icon i {
    font-size: 3rem;
    color: #ffc107;
}

.modal-body p {
    text-align: center;
    margin-bottom: 1rem;
    color: var(--text-color);
}

.modal-ref {
    text-align: center;
    color: var(--text-light);
    font-size: 0.9rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem;
    border-top: 1px solid #e9ecef;
}

@@media (max-width: 768px) {
    .my-reservations-page {
        padding: 1.5rem 0;
    }

    .page-header {
        flex-direction: column;
        gap: 1rem;
    }

    .page-header .btn {
        width: 100%;
    }

    .filter-tabs {
        flex-direction: column;
        gap: 0.5rem;
    }

    .reservations-grid {
        grid-template-columns: 1fr;
    }

    .reservation-list-item {
        grid-template-columns: 1fr;
    }

    .item-image {
        width: 100%;
        height: 200px;
    }

    .item-details {
        flex-direction: column;
        gap: 0.5rem;
    }

    .item-actions {
        flex-direction: row;
    }
}
</style>
