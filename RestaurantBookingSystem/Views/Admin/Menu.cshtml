@model MenuManagementViewModel
@{
    ViewData["Title"] = "Menu Management";
}

<div class="menu-page">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1><i class="fas fa-utensils"></i> Menu Management</h1>
                <p class="subtitle">Manage your restaurant's menu items and categories</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="manageCategories()">
                    <i class="fas fa-list"></i> Categories
                </button>
                <button class="btn btn-primary" onclick="openAddItemModal()">
                    <i class="fas fa-plus"></i> Add Menu Item
                </button>
            </div>
        </div>

        <!-- Category Tabs -->
        <div class="category-tabs">
            <button class="category-tab active" data-category="all" onclick="filterByCategory('all')">
                All Items (@Model.MenuItems.Count())
            </button>
            @foreach (var category in Model.Categories)
            {
                <button class="category-tab" data-category="@category.Name" onclick="filterByCategory('@category.Name')">
                    @category.Name (@Model.MenuItems.Count(m => m.CategoryName == category.Name))
                </button>
            }
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-controls">
                <div class="filter-group">
                    <label>Sort by:</label>
                    <select id="sortBy" class="form-control-sm" onchange="sortItems()">
                        <option value="name">Name (A-Z)</option>
                        <option value="price-low">Price (Low to High)</option>
                        <option value="price-high">Price (High to Low)</option>
                        <option value="popular">Most Popular</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Availability:</label>
                    <select id="availabilityFilter" class="form-control-sm" onchange="filterByAvailability()">
                        <option value="all">All</option>
                        <option value="available">Available</option>
                        <option value="unavailable">Out of Stock</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Dietary:</label>
                    <select id="dietaryFilter" class="form-control-sm" onchange="filterByDietary()">
                        <option value="all">All</option>
                        <option value="vegetarian">Vegetarian</option>
                        <option value="vegan">Vegan</option>
                        <option value="gluten-free">Gluten-Free</option>
                    </select>
                </div>

                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchBox" placeholder="Search menu items..." onkeyup="searchItems()" />
                </div>
            </div>
        </div>

        <!-- Menu Grid -->
        <div class="menu-grid">
            @foreach (var item in Model.MenuItems)
            {
                <div class="menu-card" data-category="@item.CategoryName" data-available="@item.IsAvailable.ToString().ToLower()">
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <div class="menu-card-image" style="background-image: url('@item.ImageUrl')">
                            @if (!item.IsAvailable)
                            {
                                <div class="unavailable-overlay">Out of Stock</div>
                            }
                            @if (item.IsPopular)
                            {
                                <div class="popular-badge">
                                    <i class="fas fa-fire"></i> Popular
                                </div>
                            }
                        </div>
                    }
                    
                    <div class="menu-card-body">
                        <div class="item-header">
                            <h3>@item.Name</h3>
                            <div class="item-price">$@item.Price.ToString("0.00")</div>
                        </div>

                        <p class="item-description">@item.Description</p>

                        <div class="item-tags">
                            @if (item.IsVegetarian)
                            {
                                <span class="tag tag-vegetarian">
                                    <i class="fas fa-leaf"></i> Vegetarian
                                </span>
                            }
                            @if (item.IsVegan)
                            {
                                <span class="tag tag-vegan">
                                    <i class="fas fa-seedling"></i> Vegan
                                </span>
                            }
                            @if (item.IsGlutenFree)
                            {
                                <span class="tag tag-gluten-free">
                                    <i class="fas fa-wheat"></i> Gluten-Free
                                </span>
                            }
                            @if (item.IsSpicy)
                            {
                                <span class="tag tag-spicy">
                                    <i class="fas fa-pepper-hot"></i> Spicy
                                </span>
                            }
                        </div>

                        @if (item.Allergens != null && item.Allergens.Any())
                        {
                            <div class="allergens">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Contains: @item.Allergens</span>
                            </div>
                        }

                        <div class="item-meta">
                            <span class="category-label">@item.CategoryName</span>
                            @if (item.PreparationTime.HasValue)
                            {
                                <span class="prep-time">
                                    <i class="fas fa-clock"></i> @item.PreparationTime min
                                </span>
                            }
                        </div>
                    </div>

                    <div class="menu-card-actions">
                        <button class="btn-action" onclick="toggleAvailability(@item.MenuItemId)" title="Toggle Availability">
                            <i class="fas fa-@(item.IsAvailable ? "eye" : "eye-slash")"></i>
                        </button>
                        <button class="btn-action" onclick="editMenuItem(@item.MenuItemId)" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action" onclick="duplicateItem(@item.MenuItemId)" title="Duplicate">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn-action btn-danger" onclick="deleteMenuItem(@item.MenuItemId)" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            }
        </div>

        @if (!Model.MenuItems.Any())
        {
            <div class="empty-state">
                <i class="fas fa-utensils"></i>
                <h3>No Menu Items Yet</h3>
                <p>Start building your menu by adding your first item.</p>
                <button class="btn btn-primary" onclick="openAddItemModal()">
                    <i class="fas fa-plus"></i> Add First Item
                </button>
            </div>
        }
    </div>
</div>

<!-- Add/Edit Menu Item Modal -->
<div id="menuItemModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="modalTitle">Add Menu Item</h3>
            <button class="modal-close" onclick="closeMenuItemModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="menuItemForm" enctype="multipart/form-data">
                <input type="hidden" id="menuItemId" />

                <div class="form-group">
                    <label class="form-label required">Item Name</label>
                    <input type="text" id="itemName" class="form-control" placeholder="e.g., Margherita Pizza" required />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">Category</label>
                        <select id="itemCategory" class="form-control" required>
                            <option value="">Select category</option>
                            @foreach (var category in Model.Categories)
                            {
                                <option value="@category.CategoryId">@category.Name</option>
                            }
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Price ($)</label>
                        <input type="number" id="itemPrice" class="form-control" step="0.01" min="0" placeholder="12.99" required />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">Description</label>
                    <textarea id="itemDescription" class="form-control" rows="3" 
                              placeholder="Describe the dish..." required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Ingredients</label>
                    <input type="text" id="itemIngredients" class="form-control" 
                           placeholder="Tomato, Mozzarella, Basil..." />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Preparation Time (minutes)</label>
                        <input type="number" id="prepTime" class="form-control" min="1" placeholder="15" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Calories</label>
                        <input type="number" id="calories" class="form-control" min="0" placeholder="450" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Allergens</label>
                    <input type="text" id="allergens" class="form-control" 
                           placeholder="e.g., Nuts, Dairy, Gluten" />
                </div>

                <div class="form-group">
                    <label class="form-label">Item Photo</label>
                    <div class="file-upload-area">
                        <input type="file" id="itemPhoto" accept="image/*" hidden />
                        <div id="photoPreview" class="photo-preview-container">
                            <div class="upload-placeholder" onclick="document.getElementById('itemPhoto').click()">
                                <i class="fas fa-camera"></i>
                                <p>Click to upload photo</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Dietary Options</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" id="isVegetarian" />
                            <span>Vegetarian</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="isVegan" />
                            <span>Vegan</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="isGlutenFree" />
                            <span>Gluten-Free</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="isSpicy" />
                            <span>Spicy</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="isPopular" />
                            <span>Popular Item</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="isAvailable" checked />
                        <strong>Available for Order</strong>
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeMenuItemModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveMenuItem()">
                <i class="fas fa-save"></i> Save Item
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function filterByCategory(category) {
            // Update active tab
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Filter cards
            document.querySelectorAll('.menu-card').forEach(card => {
                if (category === 'all' || card.dataset.category === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterByAvailability() {
            const filter = document.getElementById('availabilityFilter').value;
            
            document.querySelectorAll('.menu-card').forEach(card => {
                if (filter === 'all' || 
                    (filter === 'available' && card.dataset.available === 'true') ||
                    (filter === 'unavailable' && card.dataset.available === 'false')) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterByDietary() {
            // Implement dietary filtering
            console.log('Filter by dietary');
        }

        function sortItems() {
            // Implement sorting
            console.log('Sort items');
        }

        function searchItems() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            document.querySelectorAll('.menu-card').forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function openAddItemModal() {
            document.getElementById('modalTitle').textContent = 'Add Menu Item';
            document.getElementById('menuItemForm').reset();
            document.getElementById('menuItemModal').style.display = 'flex';
        }

        function closeMenuItemModal() {
            document.getElementById('menuItemModal').style.display = 'none';
        }

        function editMenuItem(itemId) {
            document.getElementById('modalTitle').textContent = 'Edit Menu Item';
            document.getElementById('menuItemId').value = itemId;
            // Fetch and populate item data
            document.getElementById('menuItemModal').style.display = 'flex';
        }

        function saveMenuItem() {
            const formData = new FormData();
            // Gather form data
            formData.append('name', document.getElementById('itemName').value);
            // ... add other fields

            fetch('/Admin/SaveMenuItem', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeMenuItemModal();
                    location.reload();
                }
            });
        }

        function toggleAvailability(itemId) {
            fetch(`/Admin/ToggleMenuItemAvailability/${itemId}`, { method: 'POST' })
                .then(() => location.reload());
        }

        function duplicateItem(itemId) {
            if (confirm('Create a duplicate of this item?')) {
                fetch(`/Admin/DuplicateMenuItem/${itemId}`, { method: 'POST' })
                    .then(() => location.reload());
            }
        }

        function deleteMenuItem(itemId) {
            if (confirm('Are you sure you want to delete this menu item?')) {
                fetch(`/Admin/DeleteMenuItem/${itemId}`, { method: 'DELETE' })
                    .then(() => location.reload());
            }
        }

        function manageCategories() {
            // Open category management modal
            alert('Category management coming soon');
        }

        // Photo upload preview
        document.getElementById('itemPhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photoPreview').innerHTML = `
                        <img src="${e.target.result}" alt="Preview" class="preview-image" />
                        <button type="button" class="btn-remove-photo" onclick="removePhoto()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                };
                reader.readAsDataURL(file);
            }
        });

        function removePhoto() {
            document.getElementById('itemPhoto').value = '';
            document.getElementById('photoPreview').innerHTML = `
                <div class="upload-placeholder" onclick="document.getElementById('itemPhoto').click()">
                    <i class="fas fa-camera"></i>
                    <p>Click to upload photo</p>
                </div>
            `;
        }

        window.onclick = function(event) {
            const modal = document.getElementById('menuItemModal');
            if (event.target == modal) {
                closeMenuItemModal();
            }
        }
    </script>
}

<style>
.menu-page {
    padding: 2rem;
    background: #f5f7fa;
    min-height: calc(100vh - 80px);
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 2rem;
}

.page-header h1 {
    font-size: 2rem;
    color: var(--text-color);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.subtitle {
    color: var(--text-light);
}

.header-actions {
    display: flex;
    gap: 1rem;
}

/* Category Tabs */
.category-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
}

.category-tab {
    padding: 0.75rem 1.5rem;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    color: var(--text-color);
    white-space: nowrap;
    transition: var(--transition);
}

.category-tab:hover {
    border-color: var(--primary-color);
}

.category-tab.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

/* Filter Bar */
.filter-bar {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.filter-controls {
    display: flex;
    gap: 1.5rem;
    align-items: end;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-group label {
    font-weight: 600;
    font-size: 0.875rem;
}

.form-control-sm {
    padding: 0.5rem 0.75rem;
    border: 2px solid #e9ecef;
    border-radius: 6px;
}

.search-box {
    flex: 1;
    position: relative;
    min-width: 250px;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
}

.search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
}

/* Menu Grid */
.menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2rem;
}

.menu-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: var(--transition);
}

.menu-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.menu-card-image {
    height: 200px;
    background-size: cover;
    background-position: center;
    position: relative;
}

.unavailable-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.7);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.25rem;
}

.popular-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    color: white;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.menu-card-body {
    padding: 1.5rem;
}

.item-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
}

.item-header h3 {
    font-size: 1.25rem;
    color: var(--text-color);
    margin: 0;
    flex: 1;
}

.item-price {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
}

.item-description {
    color: var(--text-light);
    line-height: 1.6;
    margin-bottom: 1rem;
}

.item-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.tag {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.tag-vegetarian {
    background: #d4edda;
    color: #155724;
}

.tag-vegan {
    background: #c3e6cb;
    color: #0f4229;
}

.tag-gluten-free {
    background: #fff3cd;
    color: #856404;
}

.tag-spicy {
    background: #f8d7da;
    color: #721c24;
}

.allergens {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: #fff3cd;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #856404;
    margin-bottom: 1rem;
}

.allergens i {
    color: #ffc107;
}

.item-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
}

.category-label {
    padding: 0.25rem 0.75rem;
    background: #e9ecef;
    color: var(--text-color);
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.prep-time {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-light);
}

.menu-card-actions {
    display: flex;
    justify-content: space-around;
    padding: 1rem;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
}

.btn-action {
    width: 40px;
    height: 40px;
    border: none;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-color);
}

.btn-action:hover {
    background: var(--primary-color);
    color: white;
    transform: scale(1.1);
}

.btn-action.btn-danger:hover {
    background: var(--error-color);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 12px;
}

.empty-state i {
    font-size: 4rem;
    color: var(--text-light);
    margin-bottom: 1.5rem;
    opacity: 0.5;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 700px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
}

.modal-body {
    padding: 2rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem;
    border-top: 1px solid #e9ecef;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.form-label.required::after {
    content: ' *';
    color: var(--error-color);
}

.form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
}

.file-upload-area {
    border: 2px dashed #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
}

.photo-preview-container {
    position: relative;
}

.upload-placeholder {
    padding: 2rem;
    cursor: pointer;
    transition: var(--transition);
}

.upload-placeholder:hover {
    background: #f8f9fa;
}

.upload-placeholder i {
    font-size: 3rem;
    color: var(--text-light);
    margin-bottom: 1rem;
}

.preview-image {
    max-width: 100%;
    border-radius: 8px;
}

.btn-remove-photo {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 32px;
    height: 32px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
}

.checkbox-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

@@media (max-width: 768px) {
    .menu-page {
        padding: 1rem;
    }

    .page-header {
        flex-direction: column;
        gap: 1rem;
    }

    .header-actions {
        width: 100%;
    }

    .menu-grid {
        grid-template-columns: 1fr;
    }

    .filter-controls {
        flex-direction: column;
        width: 100%;
    }

    .filter-group,
    .search-box {
        width: 100%;
    }

    .form-row,
    .checkbox-grid {
        grid-template-columns: 1fr;
    }
}
</style>
